# MQTT and telnet use by P1P2MQTT (and P1P2-bridge-esp8266)

This document describes how MQTT and telnet are used to control the P1P2MQTT bridge, and to initially set up the bridge to connect to WiFi and your MQTT server.

Many of these commands are also available in Home Assistant.

#### Initial set-up of WiFi and MQTT on ESP8266

Only for first time usage: Wifi parameters and MQTT settings can be configured after first boot using wifimanager's AP (connect to 192.168.4.1 on SSID P1P2MQTT, password P1P2P3P4, and fill in details). WiFi and MQTT server details will be stored afterwards. Note: if MQTT details are not correct, the only way to connect to the bridge is by telnet or by retriggigering the wifiManager (by a double-reset).

Both telnet and MQTT allow direct command execution and feedback.

## Telnet usage

In telnet, commands can be entered directly, and output is directly visible.

In addition, various output formats in a telnet session can be enabled and disabled. For example, `J12` will show hex raw data output, and `J2` will silence the raw data output. The `J` command shows the various options.

```
$ telnet 192.168.4.122
Trying 192.168.4.122...
Connected to 192.168.4.122.
Escape character is '^]'.

Welcome 192.168.4.240 to P1P2-bridge-esp8266 v0.9.14 compiled Aug  2 2022 12:29:12
(Use ^] + q  to disconnect.)
P1P2/S/122 * [ESP] Uptime 740
J3
P1P2/S/122 * [ESP] Outputmode set to 0x3
P1P2/S/122 * [ESP] Uptime 750
```

## MQTT usage

Topic P1P2/W can be used to give commands, and topic P1P2/S/# provides feedback.

#### How to use MQTT

A tutorial to MQTT is outside scope of this file; but MQTT topics can be monitored using
 - `mosquitto_sub -h \<host\> [-p \<portnr\>] -t P1P2/#`

and commands to P1P2MQTT (and via P1P2MQTT to P1P2Monitor) can be given by
 - `mosquitto_pub -h \<host\> [-p \<portnr\>] -t P1P2/W/\<xxx\> -m \<command_or_message\>`

where xxx is the 4th byte of the device's IPv4 address. If the 4th byte is (unknown and) left out, all P1P2MQTT instances execute the command:
 - `mosquitto_pub -h \<host\> [-p \<portnr\>] -t P1P2/W -m \<command_or_message\>`

#### MQTT topics generated by P1P2MQTT

By default the following topics are used:
- `P1P2/R/#` :          raw hex packet data as read from the P1/P2 bus (and additional pseudo-packets generated by P1P2Monitor and P1P2MQTT)
- `P1P2/S/#` :          status messages, errors, and verbose information
- `P1P2/P/P1P2MQTT/bridge0/\<X\>/\<SRC\>/\<KEY\>` : topic for parameter value \<KEY\>. Each parameter is published as a separate topic.

The topic can be configured to include a device-name and bridge-name, which is useful if you are using more than one P1P2MQTT bridge, for example, if you include both device-name ('P1P2MQTT') and bridgename ('bridge0'):

- `P1P2/R/P1P2MQTT/bridge0` :          raw hex packet data as read from the P1/P2 bus (and additional pseudo-packets generated by P1P2Monitor and P1P2MQTT)
- `P1P2/S/P1P2MQTT/bridge0` :          status messages, errors, and verbose information
- `P1P2/P/P1P2MQTT/bridge0/\<X\>/\<SRC\>/\<KEY\>` : topic for parameter value \<KEY\>. Each parameter is published as a separate topic.

In topic `P1P2/P/P1P2MQTT/bridge0/\<X\>/\<SRC\>`, X is a single character:
  - `S` for various settings
  - `T` for temperature and flow measurements
  - `M` for other measurements
  - `F` for auxiliary controller related settings
  - `A` for data generated by software on ATmega or ESP8266 (pseudo-packets)
  - `E` for schedule information
  - `U` for unknown reports <br>

while \<SRC\> identifies the parameter source:
  - `0` main controller (communicating to main system)
  - `1` main heat pump system (communicating to main controller)
  - `2` main controller (communicating to auxiliary controller)
  - `3` auxiliary controller (communicating to main controller)
  - `8` P1P2Monitor running on ATmega328P
  - `9` P1P2MQTT running on ESP8266 <br>

For example, P1P2/P/P1P2MQTT/bridge0/T/1/TempLWT reports the actual leaving water temperature as reported by the main system.

#### Example P1P2/P/# parameter data

```
P1P2/P/P1P2MQTT/bridge0/C/1/Starts_Compressor 20713
P1P2/P/P1P2MQTT/bridge0/C/1/Hours_Gasboiler_DHW 501
P1P2/P/P1P2MQTT/bridge0/A/8/ATmega_Uptime 5881
P1P2/P/P1P2MQTT/bridge0/A/9/ESP_Uptime 302
P1P2/P/P1P2MQTT/bridge0/T/1/Temperature_HP2Gas_Water 22.750
P1P2/P/P1P2MQTT/bridge0/C/1/Hours_Compressor_Heating 27843
...
```

#### Example P1P2/R/# hex packet data

Communicates raw hex packet data as it is read from the P1/P2 bus, in recommended verbose=3 mode prefixed by relative time stamp. Useful to verify operation of hardware and analyse data patterns if your model is not (fully) supported. In addition may contain timing information.

Example output:
```
P1P2/R/P1P2MQTT/bridge0 R T  0.160: 0000100001010000000014000000000800000F00003D0029
P1P2/R/P1P2MQTT/bridge0 R T  0.024: 400010000081013D000F0014001A000000000000000000E0
P1P2/R/P1P2MQTT/bridge0 R P         00000D0000000000000000000000000000000000000000C4
P1P2/R/P1P2MQTT/bridge0 R P         40000D0000000000000000000000000000000000000000B2
P1P2/R/P1P2MQTT/bridge0 R T  0.041: 00001115660000000000000B
...
```

Packets with timestamps (‘T’) originate from the P1/P2 bus. Packets without time stamp (‘P’) are pseudo-packets generated by P1P2Monitor or P1P2MQTT with internal state information.

#### Example P1P2/S/# status output

Example output after ATmega328 reboot (`P1P2/W/P1P2MQTT/bridge0 a` or `P1P2/W a`):
```
P1P2/S/P1P2MQTT/bridge0 * [ESP] 2024-05-06 21:07:35 Hard resetting ATmega...
P1P2/S/P1P2MQTT/bridge0 * [MON] 2024-05-06 21:07:35 P1P2Monitor-v0.9.45 compiled May  6 2024 01:34:18 brand 0 modelnr 3 +control NEWP1P2LIB E-series
P1P2/S/P1P2MQTT/bridge0 * [MON] 2024-05-06 21:07:35 Reset cause: MCUSR=2 (ext-reset)
P1P2/S/P1P2MQTT/bridge0 * [MON] 2024-05-06 21:07:35 P1P2-ESP-interface ATmegaHwID v1.2
P1P2/S/P1P2MQTT/bridge0 * [MON] 2024-05-06 21:07:35 Control_id=0xF0
P1P2/S/P1P2MQTT/bridge0 * [MON] 2024-05-06 21:07:35 Counter_requests=1
P1P2/S/P1P2MQTT/bridge0 * [MON] 2024-05-06 21:07:35 Ready setup
...
```

## Command and control of P1P2MQTT

Topics providing information or commands to P1P2MQTT:
- P1P2/W or P1P2/W/P1P2MQTT/bridge0 :          Channel to give commands to the P1P2MQTT and indirectly to P1P2Monitor
- P1P2/P/meter/U/9/Electricity_Power : Current electricity consumption (active power) in Watt, provided by an external electricity meter or another program, enabling P1P2MQTT to calculate COP values

#### P1P2MQTT commands for ESP8266

Commands to be executed by P1P2MQTT can be given over P1P2/W/\<xxx\> or via telnet:
- `P` Show all configuration parameters
- `P \<parameter-nr\>` Show one configuration parameter
- `P \<paramter-nr\> \<parameter-value\>` Change one configuration parameter
- `D0` Restart ESP8266
- `D` Show help for other D commands
- `S`  Display output filter level (replaces previous changed-only mode)
- `Sx` Sets output filter level:
  - 0 all parameters
  - 1 parameters only when new or when value changes
  - 2 like 1, without temperature/flow measurements (unless new)
  - 3 like 2, without date/time
- `J`  Display output mode and options
- `Jx` Sets output mode, with `x` sum of:
  - 0x0001 to output raw P1/P2 packet data over MQTT topic P1P2/R/#
  - 0x0002 to output individual parameter data over MQTT topic P1P2/P/#
  - 0x0004 to output pseudo packet data over MQTT topic P1P2/R/#
  - 0x0008 to have MQTT include parameters even if functionality is unknown, may overload ATmega/ESP
  - 0x0010 ESP to output raw data over telnet
  - 0x0020 to output MQTT individual parameter data over telnet
  - 0x0040 ESP to output timing info over telnet
  - 0x0080 (reserved)
  - 0x0100 to include non-HACONFIG parameters in P1P2/P/# 
  - 0x0200 (reserved)
  - 0x0400 (reserved)
  - 0x0800 to restart HA-data communication (and throttling) after MQTT reconnect 
  - 0x1000 to output timing data over P1P2/R/# (prefix: C/c)
  - 0x2000 to output error data over P1P2/R/# (prefix: \*)
  - 0x4000 (reserved)
  - 0x8000 to ignore serial input from ATmega
- `V` Show system information
- `U` Display scope mode (0 off, 1 on)
- `Ux` Sets scope mode (0 off (default), 1 on)

#### P1P2Monitor commands (forwarded by ESP8266 to ATmega)

All other commands received by P1P2MQTT are forwarded to P1P2Monitor on the ATmega328P. A full list of commands supported by P1P2Monitor is specified [here](https://github.com/Arnold-n/P1P2MQTT/blob/main/doc/P1P2Monitor-commands.md) but in practice you will only need the following ones:
 - `A` Execute hard reset of ATmega328P
 - `L1` Start auxiliary controller (`L` state info maintained in EEPROM)
 - `L0` Stop auxiliary controller
 - `C2` Start requesting counters (`C` state info maintained in EEPROM)
 - `C0` Stop requesting counters
 - `E` Parameter write for Daikin E-series, for example,
 - `E 35002F01` Switch heating on (packet type 0x35, parameter 0x002F, value 0x01). Other allowable formats are space-separated `E 35 2F 1` or shortening the third parameter as in `E35002F1`.
 - `F` Parameter write for Daikin F-series, for example,
 - `F 38 0 1` to set packet type 38 byte 0 to 0 to power FDY model on
 - `F 38 0 0` to power FDY model off
 - `F 38 8 51` to set FDY model heating fan mode high
